\section{Background estimation}
\label{bg}

\subsection{Background sources}
\label{bg_sources}
The vast majority of leptons from SM processes are prompt. There are, however, a few notable processes that produce leptons with large \ad values that may pass our selection: (1) leptons from prompt decays whose \ad is poorly measured ("mismeasurements"), (2) leptons from  decays of tau leptons ("taus"), and (3) leptons from decays of B or D mesons ("heavy flavor"). Note that the leptons from these processes generally do not share a common displaced vertex. We perform several cross checks to ensure that processes in which leptons share a common displaced vertex do not contribute significantly in the SRs. Section~\ref{additional_bg_checks} presents several additional studies that confirm that the SR contribution of leptons from material interactions, cosmic rays, and SM hadrons are either negligible or already accounted for by the background estimation procedure.

% discuss absence of displaced dilepton decays and cosmics and such

The \ad distributions of leptons from the three main background sources vary both by lepton flavor and parent particle. Tau leptons have a lifetime of \SI{87}{\um}, B mesons have a lifetime around \SI{500}{\um}, and D mesons have a lifetime of around \SI{100}{\um}, so leptons from taus will generally have smaller \ad values than leptons from heavy flavor. Furthermore, mismeasurements are more common for electrons than for muons due to the superior muon $d_0$ resolution. Figure~\ref{ttbar_d0_behavior}, which shows the relative contribution of each source of leptons as a function of \ad in simulated \ttbar events that pass the $\Pe\Pgm$ channel preselection, shows how mismeasurements dominate at all \ad values for electrons while taus and heavy-flavor contribute meaningfully for muons with $\gtrsim\SI{100}{\um}$.

\input{figures/bg/ttbar_d0_behavior}

\fxnote{rewrite this section to first introduce correlation concept, then single out taus and show mumu dy plot; don't forget to mention 2016 vs 2017--2018}
In the $\Pgm\Pgm$ channel, it is worth examining which long-lived SM parents will contribute to \ad-\ad correlation. The correlation specifically comes from DY-type processes in which the parentage is correlated between muons. Figure~\ref{dy_d0_behavior}, which shows the fraction of muons from different background sources in DY simulation, indicates that tau lepton decays are the main source of muons that may be correlated in this way, and that the heavy-flavor contribution is negligible. This is reasonable because while tau leptons and heavy-flavor mesons both produce displaced muons, the isolation criteria rejects the vast majority of muons from heavy-flavor mesons.  Muons from tau leptons contribute significantly from about \num{100} to \SI{500}{\um}, so we expect the most significant \ad-\ad correlation to appear in this range and peak around \SI{200}{\um}. Furthermore, the correlation will be most pronounced in the regions where the \ad measurements are the best.

\input{figures/bg/dy_d0_behavior}

\subsection{Data-driven ABCD method}
\label{abcd}
We estimate the SR background yields with a data-driven method in which the lepton \ad distributions serve as composite models of all background processes. Specifically, we employ an ABCD method using the \ad of two leptons. We label the two \ad values in each channel as \ada and \adb, which correspond to the leading $\Pe$ and leading $\Pgm$ in the $\Pe\Pgm$ channel, the leading and subleading $\Pe$ in the $\Pe\Pe$ channel, and the leading and subleading $\Pgm$ in the $\Pgm\Pgm$ channel. As a first step, we categorize the events that pass the preselection criteria into four regions (A, B, C, and D) of the \ada-\adb plane, as shown in Fig.~\ref{abcd_regions}.

\input{figures/bg/abcd_regions}

We then use the number of events in regions A, B, and C to estimate the expected background in each SR. The basic estimation procedure depends on the assumption that \ada and \adb are uncorrelated. If this assumption holds, then $N_{\text{B}}/N_{\text{A}}=N_{\text{D}}/N_{\text{C}}$ and the number of background events in D is equal to $N_{\text{B}}N_{\text{C}}/N_{\text{A}}$, where $N_{\text{X}}$ is the number of background events in the given region. We find that \ada and \adb are indeed uncorrelated over much of the \ad-\ad plane, but the correlation discussed in Section~\ref{bg_sources} renders the basic ABCD method insufficient to estimate the background in SR I. After quantifying the degree of correlation in Section~\ref{cr_closure_tests}, we define a procedure to correct the basic ABCD estimate in Section~\ref{abcd_correction}.

In order to maximize sensitivity to a wide range of new particle lifetimes, we further subdivide region D into the following four signal regions (SRs):
\begin{itemize}
    \item SR I: $\num{100}\leq\text{both }\ad<\SI{500}{\um}$
    \item SR II: $\num{100}\leq\ada<\SI{500}{\um}$, $\SI{500}{\um}<\adb<\SI{10}{\cm}$
    \item SR III: $\SI{500}{\um} \leq \ada<\SI{10}{\cm}$, $\num{100} < \adb<\SI{500}{\um}$
    \item SR IV: $\SI{500}{\um} \leq \text{both }\ad<\SI{10}{\cm}$
\end{itemize}
The exact boundaries between the four SRs are motivated by the expected contributions of the different background sources, as explained in \ref{bg_sources}. This approach also necessitates that the definitions of regions B and C vary in accordance with the SR for which a given estimate is performed (e.g. only the events in the $\num{100}\leq\ada<\SI{500}{\um}$ range of region B are considered when estimating the yields of SR I and II). Finally, we subdivide SR I into two bins using one lepton's \pt to further increase sensitivity to high-mass, low-lifetime new physics. Table~\ref{yields} lists the \pt boundary in each channel and year.

When performing the background estimate and closure tests, we treat the 2016 data and simulation separately from the 2017--2018 data and simulation to avoid any correlations between \ada and \adb that may arise from the differences between the Phase 0 and Phase 1 trackers employed by CMS in 2016 and 2017--2018, respectively (see Section~\ref{tracker}).
\fxnote{what about largeEtaAndD0 stuff?}

\subsection{Closure tests in control regions}
\label{cr_closure_tests}

We perform several closure tests of the background estimation procedure in data and simulation to test the method and quantify the degree of \ada-\adb correlation from the processes discussed in \ref{bg_sources}. Two series of tests are performed, the first in the \num{100}--\SI{500}{\um} subregions of regions B and C and the second in the \SI{500}{\um}--\SI{10}{\cm} subregions of regions B and C.

\subsubsection{\num{100}--\SI{500}{\um} tests}
We perform closure tests in subregions of regions B and C where one lepton is more prompt (\num{20}--\SI{100}{\um}) and the other is more displaced (\num{100}--\SI{500}{\um}). In these closure tests, we estimate the background yield using the simple ABCD method and then use the ratio of the actual number of events to the estimated number of events as the measure of nonclosure (and therefore \ada-\adb correlation). With this approach, a ratio of 1 corresponds to closure and no \ada-\adb correlation while ratios greater than 1 correspond to nonclosure and positive \ada-\adb correlation. Using the procedure outlined in \ref{abcd_correction}, we estimate the corresponding degree of nonclosure in SR I by fitting the resulting ratios and extrapolating from the closure test regions to SR I. We perform identical procedures in regions B and C and then average the resulting extrapolated ratios.

Table \ref{100to500um_tests} shows the average extrapolated ratios for three rounds of closure tests: one in background simulation with the \ztautaull events removed, one in the full background simulation, and one in data. The average extrapolated ratios are always compatible with one in background simulation without \ztautaull events, but they generally increase when the \ztautaull events are included. Furthermore, the average extrapolated ratios from the full background simulation generally describe the average extrapolated ratios in data. From these results, we conclude that within our statistical uncertainties, \ztautaull events are the only meaningful source of correlation and that the degree of correlation observed in data is modeled reasonably well in simulation. We also observe that the variation in the degree of correlation across channels matches our expectations: correlation increases with the number of muons in the final state and is greater in 2017--2018 than 2016 because of the improved $d_0$ resolution made possible by the Phase 1 tracker upgrade (see Section~\ref{tracker}.

\input{tables/100to500um_tests}

\subsubsection{\SI{500}{\um}--\SI{10}{\cm} tests}
We next perform closure tests in subregions of regions B and C where one lepton is more prompt (\num{20}--\SI{100}{\um}) and the other is more displaced (\SI{500}{\um}--\SI{10}{\cm}). We again use the ratio of the actual number of events to the estimated number of events as the measure of nonclosure, but in these tests we expect the ratio to be consistent with one because \ztautaull events do not contribute meaningfully beyond \SI{500}{\um}. Table \ref{500umto10cm_tests} shows that this is indeed the case for background simulation (with and without \ztautaull events and for data. These results imply that \ada and \adb are uncorrelated beyond \SI{500}{\um}, which means that a simple ABCD procedure will be adequate for estimating the background yields in SRs II, III, and IV.

\input{tables/500umto10cm_tests}

\subsection{ABCD correction and systematic uncertainty}
\label{abcd_correction}
The closure tests of Section~\ref{cr_closure_tests} show that \ada and \adb are frequently positively correlated in the \num{100}--\SI{500}{\um} region but are uncorrelated otherwise. To account for this correlation as well as other possible unforeseen sources of nonclosure, we define a procedure to correct the simple ABCD estimate in SR I and assign a systematic uncertainty to the simple ABCD estimate in all SRs.

\subsubsection{\num{100}--\SI{500}{\um} correction and systematic uncertainty}
Figures~\ref{100to500um_fits_emu}, \ref{100to500um_fits_ee}, and \ref{100to500um_fits_mumu} show the results of the closure tests in the $\Pe\Pgm$, $\Pe\Pe$, and $\Pgm\Pgm$ channels, respectively, in the one-prompt (\num{20}--\SI{100}{\um})/one-displaced (\num{100}-\SI{500}{\um}) sidebands in the \num{100}--\SI{500}{\um} region, in data. These plots show the ratio of the actual to the estimated number of events as a function of the prompt lepton \ad. In all of these plots, the binning of the prompt lepton axis is initially \SI{10}{\um} wide. Starting from most-displaced bin, we test to see if any bin has fewer than 5 events, and if so, we combine it with whichever neighboring bin has fewer events, repeating until all bins have at least 5 events.

We then fit the data with a straight line, where the slope and y-intercept are allowed to vary. This fit is used to find the ratio at \SI{200}{\um} (the extrapolation into SR I), which is where we expect the largest contribution from tau lepton decays, as was shown in Section~\ref{bg_sources}. \SI{200}{\um} also happens to be approximately the center-of-mass of the \num{100}--\SI{500}{\um} bin in background simulation. We average the two extrapolated ratios and derive a correction and systematic uncertainty from this average extrapolated ratio.

\input{figures/bg/100to500um_fits}

If the average extrapolated ratio is $>1.0$, we take the central value as a multiplicative correction to the background estimate and the uncertainty in the average as a systematic uncertainty in the background estimate. In this case, we also vary the \SI{200}{\um} extrapolation point by $\pm\SI{50}{\um}$, as we find that the width of the tau lepton contribution as a function of \ad is about \SI{50}{\um}. We apply the difference from this variation in extrapolation point as an additional systematic uncertainty in the background estimate. If the average is $\leq 1.0$, we set the correction equal to $1.0$ and use the uncertainty in the average as a symmetric systematic uncertainty about $1.0$. Table~\ref{100to500um_estimates} shows the resulting correction factors along with the uncorrected and corrected SR I background estimate.

\input{tables/100to500um_estimates}

\subsubsection{\SI{500}{\um}--\SI{10}{\cm} systematic uncertainty}
As shown above, no correction to the background estimate is needed in the \SI{500}{\um}--\SI{10}{\cm} region, since the tau lepton contribution is negligible here. In this region, we derive a systematic uncertainty in the background estimate from the data closure tests shown in Section~\ref{cr_closure_tests}. We take the largest deviation from \num{1.0} that occurs in the ratio of the actual to the estimated number of events plus its uncertainty, in either of the two closure tests that correspond to a given SR, as a systematic uncertainty. This is a conservative approach that produces a large systematic uncertainty in the small background yields that we predict in these regions. Table \ref{500umto10cm_estimates} shows the systematic uncertainty and the predicted number of events in SRs II, III, and IV.

\input{tables/500umto10cm_estimates}

\subsection{Testing full background estimation procedure}

Having defined the full background estimation procedure and seen that the \ada-\adb correlation observed in data is also present in simulated background events, we now perform a final closure test of the full background estimation method using simulated background events in SRs I--IV.

Table~\ref{sr_closure_tests} shows the estimated and actual number of simulated background events in SRs I--IV. The listed estimates include all corrections and statistical and systematic uncertainties as discussed in \ref{abcd_correction}. The uncertainties in the actual values are purely statistical.The general agreement between estimated and actual yields leads us to conclude that the background estimation procedure is valid and the assigned systematic uncertainties are sufficient to cover any potential sources of nonclosure that we have not explicitly considered.
% add discussion on cosmics etc

\input{tables/sr_closure_tests}

\subsection{Additional background checks}
\label{additional_bg_checks}
We perform a few additional studies to check for other potential sources of background. We find that their SR contributions are either negligible or already covered by the background estimation method described above.

\subsubsection{Material interactions}
In order to further study the material interactions, we invert the preselection criterion that rejects good vertices in the material. In data, we find seven events, across all channels and years, that pass the preselection with this inverted criterion. As shown in Table~\ref{material_interaction_evts}, three of these events are in the Prompt Control Region, and four are in region B or region C. The lepton vertices in these events coincide with the material as we expect: two are in the beampipe, one is in the BPIX inner shield, and four are in BPIX layer 1. To summarize, even with  the material interaction veto inverted, we find no SR events resulting from material interactions and therefore conclude that material interactions are not a significant background after the full selection is applied.
% \FIXME : make sure bpix is defined

\input{tables/material_interaction_evts}

\subsubsection{Cosmic-ray muons}
To estimate the SR contribution of cosmic-ray muons, we perform a study in which we invert the $\Delta t$ and $\cos{\alpha}$ criteria in the $\Pgm\Pgm$ preselection and then check how many of these events in data are in the SRs. We find three events in data with these criteria (one event per year, all in SR IV). We find the efficiency to pass the $\Delta t$ and $\cos{\alpha}$ criteria in NoBPTX data, which is predominantly cosmic-ray muon events, on top of the rest of the $\Pgm\Pgm$ preselection criteria. Zero events in NoBPTX data pass all of the preselection criteria, and \num{3736} events in NoBPTX data pass all of the preselection criteria except these two cosmic rejection selections. To conservatively estimate the efficiency, we fluctuate the 0 events up to 1 and find an efficiency of $1/3736$. We therefore find the approximate upper bound on the SR contribution of cosmic ray muons to be $3\times\frac{1}{3736}=0.0008$, which is negligible compared to the background estimation in each SR.

\subsubsection{Heavy-flavor mesons}
To estimate an upper limit on the SR contribution of leptons from heavy-flavor mesons, we perform two studies.

First, we estimate SR yields with a simple ABCD method in 2018 $\Pgm\Pgm$ preselection data while additionally requiring at least one medium CSVv2 \PQb-tagged jet. The test is performed in the $\Pgm\Pgm$ channel because it contains the smallest relative SR contribution from mismeasurements and should therefore be most sensitive to heavy flavor. As shown in Table~\ref{abcd_hf_data}, the background estimates are about an order of magnitude smaller than when no \PQb jet is required in our usual preselection.
%\FIXME: cite csv

\input{tables/abcd_hf_data}

Next, we look at samples in 2018 data and simulated QCD\fxnote{define qcd in this context} events that pass the $\Pgm\Pgm$ preselection with the isolation criterion inverted. These samples are dominated by muons from B meson decays, and the QCD simulation describes the data well in the region outside of the $Z$ boson peak, as can be seen in Fig.~\ref{mumu_inv_mass_inverted_iso}. We use this QCD sample to test the heavy-flavor background in two ways. First, we perform a simple ABCD estimate in the simulated QCD events to check for \ada-\adb correlation. As shown in Table~\ref{abcd_hf_mc}, we find no evidence of correlation, which indicates that the background estimation already accounts for the heavy-flavor background. Second, we estimate the approximate heavy-flavor background in the SRs by taking the ratio of SR to prompt control region events in QCD simulation from the anti-isolated region and the normalization from the number of simulated QCD events that pass the $\Pgm\Pgm$ preselection. Using this approach, we estimate that the heavy-flavor background to be $0.06^{+0.13}_{-0.05}$ events in SR I and $0.0015^{+0.0034}_{-0.0012}$ events in SR IV, which is small relative to the nominal prediction shown in the first row of Table~\ref{abcd_hf_data}.

\input{figures/bg/mumu_inv_mass_inverted_iso}
\input{tables/abcd_hf_mc}

We therefore conclude that the heavy-flavor SR contribution is small and already accounted for in our background estimates.

\subsubsection{Low-mass SM hadrons}
To estimate an upper limit on the SR contribution of leptons from decays of low-mass SM hadrons, we examine 2018 data and QCD simulation in the $\Pgm\Pgm$ channel with both the muon isolation and the $\DR$ requirements inverted. As shown in Fig.~\ref{mumu_inv_mass_inverted_iso_lo}, this region is dominated low-mass $\Pgm\Pgm$ pairs, with clear J/$\psi$, $\psi^\prime$, and $\Upsilon$ mass peaks. Many of these leptons are displaced, especially those in the J/$\psi$ mass range. To estimate the fraction of such leptons that will be displaced, we take the ratio of SR to prompt control region events of SM hadrons that decay to leptons from data in this region.
% \FIXME: cite something for mass peaks?

\input{figures/bg/mumu_inv_mass_inverted_iso_lo}

Even though the inverted-isolation region is dominated by low-mass muon pairs, the only QCD simulation event that survives the 2018 $\Pgm\Pgm$ preselection has a di-muon invariant mass of approximately 300\GeV. Furthermore, the muons are not near each other in the $\eta-\phi$ plane ($\DR\approx3$), which is inconsistent with the low-mass SM hadron events that dominate the region with the inverted isolation and $\DR$ criteria. To find a normalization from which to estimate the low-mass SM hadron SR contribution, we therefore turn to the inverted-isolation sample used above in the heavy-flavor meson cross check. In this sample, the ratio of events with $\DR<0.5$ to events with $2.8<\DR<3.2$ is about $0.1$. We find $0.2$ QCD simulated events that pass the nominal preselection, and so we estimate that of the events passing the 2018 $\Pgm\Pgm$ preselection, about $0.02$ contain pairs of muons produced in low-mass SM hadron decays. We estimate the SR contributions using this preselection normalization and the ratio of SR to prompt control region events from the sample of SM hadrons that decay to leptons in data. We find this contribution is less than $0.006^{+0.013}_{-0.005}$ events in SR I and less than $0.001^{+0.002}_{-0.001}$ events in SR IV, which, if compared with the nominal prediction shown in the first row of Table~\ref{mumu_inv_mass_inverted_iso}, are respectively negligible and covered by the \SI{140}{\percent} systematic uncertainty already applied in this region.


\pagebreak