\section{Event selection}
\label{selection}
\fxnote{add intro blurb?}
\subsection{Triggers}
The events are required to pass different triggers in each channel. Standard CMS electron and muon triggers are not designed for displaced objects, so we use nonstandard triggers for both electrons and muons. For muons, we remove all trigger requirements relating to the muon $d_0$, longitudinal impact parameter ($d_z$), or the vertex from which the muon originates. For electrons, we actually use photon triggers, which collect events with electrons as well as photons but do not rely on any tracking information. See Section~\ref{trigger} for a brief overview of the CMS trigger system.

In the \Pe\Pgm\ channel, 2016 data and corresponding simulated events are required to pass the logical OR of two HLT paths (\longvar{HLT_Mu38NoFiltersNoVtx_Photon38_CaloIdL_v*} OR \longvar{HLT_Mu28NoFiltersNoVtxDisplaced_Photon28_CaloIdL_v*}) that were both originally designed for the 2015 CMS displaced leptons analysis~\cite{displaced_leptons_bing}. The first trigger requires at least one muon with $\pt>\SI{38}{\GeV}$ and places no constraints on the vertex, $d_0$, or $d_z$. The second trigger requires at least one muon with $\pt>\SI{28}{\GeV}$ and $\ad>\SI{0.01}{\cm}$. Each of these two triggers also requires at least one photon that passes a loose calorimeter-based identification. The first (second) trigger requires that the photon \ET is greater than \SI{38}{\GeV} (\SI{28}{\GeV}). The signal efficiency with these dedicated triggers is significantly higher than that of standard muon-photon HLT paths.

In 2017 and 2018, data and corresponding simulated events in the \Pe\Pgm\ channel are required to pass \longvar{HLT_Mu43NoFiltersNoVtx_Photon43_CaloIdL_v*}. The muon \pt and photon \ET thresholds are raised with respect to 2016 due to increased pileup. A version of the 2016 trigger that requires displaced muons is not available in 2017 and 2018.

In the \Pe\Pe\ channel, 2016 data and corresponding simulated events are required to pass the logical OR of two HLT paths (\longvar{HLT_Diphoton30_18_R9Id_OR_IsoCaloId_AND_HE_R9Id_Mass90_v*} OR  \longvar{HLT_DoublePhoton60_v*}). The first requires a leading photon with $\ET>30\GeV$ and a subleading photon with $\ET>\SI{18}{\GeV}$. Photons must pass calorimeter identification criteria involving isolation, the ratio of HCAL to ECAL energy, and shower shape, and the di-photon invariant mass must be $>\SI{90}{\GeV}$. This path is highly efficient at low top squark mass. The second trigger simply requires at least two photons with $\ET>\SI{60}{\GeV}$. This path is highly efficient at large top squark mass and lifetime.

In 2017 and 2018, data and corresponding simulated events in the \Pe\Pe\ channel are required to pass \longvar{HLT_Diphoton30_22_R9Id_OR_IsoCaloId_AND_HE_R9Id_Mass90_v*} OR  \longvar{HLT_DoublePhoton70_v*}. The photon \ET thresholds are raised with respect to 2016 due to increased pileup.

In the \Pgm\Pgm\ channel, 2016 data and corresponding simulated events are required to pass the logical OR of two HLT paths (\longvar{HLT_DoubleMu33NoFiltersNoVtx_v*} OR \longvar{HLT_DoubleMu23NoFiltersNoVtxDisplaced_v*}) that were both designed for this analysis. The first trigger requires at least two muons with $\pt>\SI{33}{\GeV}$ and sets no constraints on the vertex, $d_0$, or $d_z$. The second trigger requires at least two muons with $\pt>\SI{23}{\GeV}$ and $\ad>\SI{0.01}{\cm}$. The signal efficiency with these dedicated triggers is significantly higher than that of standard di-muon HLT paths.

In 2017 and 2018, data and corresponding simulated events in the \Pgm\Pgm\ channel are required to pass \longvar{HLT_DoubleMu43NoFiltersNoVtx_v*}. The muon \pt threshold is raised with respect to 2016 due to increased pileup. A version of the 2016 trigger that requires displaced muons is not available in 2017 and 2018.

\subsection{Preselection}
\label{preselection}
Starting from the events collected with the triggers described above, we next apply a set of preselection criteria to select the events to be analyzed. The preselection criteria vary by channel and year, but the fundamental goal is always to select events with at least one good reconstructed lepton of each flavor required by the channel. 

Specifically, the \Pe\Pgm\ preselection selects events with at least one PF electron and at least one global PF muon, the \Pe\Pe\ preselection selects events with at least two PF electrons, and the \Pgm\Pgm\ preselection selects events with at least two global PF muons (see Section~\ref{cms_reco} for a discussion of the PF algorithm). We set requirements on these electrons and muons as shown in Tables~\ref{preselection_emu}, \ref{preselection_ee}, and \ref{preselection_mumu}. The electron and muon \pt  requirements are chosen such that the trigger efficiency is independent of lepton \pt,\fxnote{reference trig eff section after adding trig eff plots} while electron and muon $\abs{\eta}$ requirements are chosen to reduce the fraction of leptons with poorly measured $d_0$ (see Appendix~\ref{large_eta}). Electrons that traverse the gap between the endcap and barrel detectors are also rejected due to the known decrease in reconstruction performance in this region.

\input{tables/preselection_emu}
\input{tables/preselection_ee}
\input{tables/preselection_mumu}

We use a tight cut-based identification (ID) on the electrons and muons to select well-reconstructed leptons, but unlike the standard ID definitions used in many CMS analyses, we do not place any requirements on $d_0$ or $d_z$. In all other respects, we follow the cut-based ID recommendations of the CMS EGamma and Muon Physics Object Groups. The electron ID corresponds to \longvar{egmGsfElectronIDs:cutBasedElectronID-Summer16-80X-V1-tight} in 2016, \longvar{egmGsfElectronIDs:cutBasedElectronID-Fall17-94X-V1-tight} in 2017, and \longvar{egmGsfElectronIDs:cutBasedElectronID-Fall17-94X-V2-tight} in 2018. The electron and muon tight ID requirements are summarized in Tables \ref{e_tight_id} and \ref{tab:mu_tight_id}.

\input{tables/e_tight_id}
\input{tables/mu_tight_id}

We also require that electrons and muons are isolated. Specifically, we use a modified isolation definition that accounts for the fact that displaced leptons may be associated with the wrong primary vertex. The standard PF isolation assumes all energy from primary vertices other than the leading primary vertex is due to pileup, which is not true when the primary vertex ordering is altered by an incorrectly associated lepton. We have therefore modified the isolation definition to be agnostic to the primary vertex ordering by allowing PF candidates from any primary vertex to contribute to the isolation sum and by using a simple $\rho$-based pileup correction, where $\rho$ is the total transverse energy of all the PF candidates in an event divided by the total detector area. The modified isolation is calculated as:
\begin{equation}
    \text{relative isolation} = \frac{\text{max}\left(0,\ \pt^{h^{\pm}} + \ET^{h^0} + \ET^{\Pgg} - \rho\pi R^2\right)}{\pt^{\ell}}
\end{equation}
where $R$ is the radius of a cone in the $\eta$-$\phi$ plane that is centered on the lepton, $\pt^{h^{\pm}}$ is the total \pt of charged hadrons in the cone, $\ET^{h^0}$ is the total \ET of neutral hadrons in the cone, $\ET^{\Pgg}$ is the total contribution of photons in the cone, $\rho$ is defined as above, and $\pt^{\ell}$ is the lepton \pt. R is set to \num{0.3} for electrons and \num{0.4} for muons.

Figure~\ref{iso_pu_term_comparison} shows how the size of the pileup correction term depends on lepton displacement in the standard isolation but not in the modified isolation described here. We use the modified isolation definition for both electrons and muons while keeping the original tight working point for electrons and slightly tightening the tight working point for muons. In the end, we require that the relative isolation is $<0.10$ for muons and $<0.0588$ for electrons in 2016 and $<0.0287+0.506/\pt$ for electrons in 2017 and 2018. As shown in Figs.~\ref{iso_performance_comparison} and \ref{iso_signal_bg}, this modified PF isolation rejects substantially more background when the leptons are displaced but does not significantly alter the signal yield. We note, however, that there may still be some minor dependence on the primary vertex selection in the PF muon requirement because the PF muon selection includes some loose isolation requirements where the charged hadron component is constrained to the selected primary vertex.

\input{figures/selection/custom_iso}

We also reject electrons and muons in certain regions of the $\eta$-$\phi$ plane where lepton $d_0$ is more likely to be mismeasured. We identify these regions as highly populated bins in the electron $\eta$-$\phi$ distribution in a prompt-muon, displaced-electron control region in 2017 and 2018 data (see Fig.\ref{eta_phi_vetos}). No such bins are present in 2016 data. The identified regions coincide with regions found by a previous CMS analysis~\cite{disappearing_tracks} to be affected by power supply issues in the pixel detector. The $\eta$-$\phi$ variation is more apparent for displaced electrons than displaced muons, so we use data in a prompt muon ($\ad<\SI{40}{\um}$), displaced electron ($\num{100}<\ad<\SI{500}{\um}$) control region to define the  regions used for both electrons and muons. In 2017, the rejected region is $1.0<\eta<1.5$ AND $\phi>2.7$, and in 2018 the rejected region is $0.3<\eta<1.2$ AND $0.4<\phi<0.8$.

\input{figures/selection/eta_phi_vetos}

In addition to these object-level selections, we also impose a few event-level selections designed to remove potential backgrounds from cosmic rays, material interactions, and displaced decays of SM hadrons. To remove cosmic-ray muons in the \Pgm\Pgm\ and \Pe\Pgm\ channels, we require there be zero pairs of muons with $\cos{\alpha}<-0.99$, where $\alpha$ is the 3D angle between the muons, and that the relative time between the leading two muons is inconsistent with the timing of cosmic-ray muons\fxnote{include plots?}. To do this, we look at the muon time measured by the DTs and CSCs, which assume that the muons are traveling outwards from the center of the detector. We then use the muon $\phi$ measurements to determine which muon is above the other and find $\Delta t$, the time of the lower muon subtracted from the time of the upper muon. We reject events with $\Delta t< -20\ns$ if the number of degrees of freedom of the timing measurements for both muons is greater than seven. To remove leptons from decays of SM hadrons, we require that the candidate leptons not be too close together in the $\eta$-$\phi$ plane. Specifically, we find that requiring $\DR>0.2$ significantly reduces the contribution from SM hadrons without noticeably affecting the signal acceptance. To remove leptons from material interactions, we reject events in which the candidate leptons form a good displaced vertex that overlaps with the tracker material. The vertices are reconstructed with the Kalman Vertex Fitter, and a ``good'' vertex is one with $\chi^{2}/\mathrm{n_{dof}}< 20$. The tracker material map is obtained from the tracker material budget measurements~\cite{Sirunyan:2018icq,CMS-DP-2019-001}. See Section~\ref{additional_bg_checks} for tests in data that involve inverting the criteria described in this paragraph. 

Finally, to ensure that the signal regions of all three channels are orthogonal to one another, we reject events in the \Pe\Pe\ (\Pgm\Pgm) channel with at least one muon (electron) that passes the \Pe\Pgm\ channel preselection and has $\ad>\SI{100}{\um}$.

In contrast to previous displaced leptons analyses~\cite{displaced_leptons_run1, displaced_leptons_bing}, we allow for the possibility of more than one lepton of each type in a given channel and set no requirements on the charge product of the lepton pair. These changes were made at the request of several theorists, including the authors of Ref.~\cite{Evans:2016zau}.

Figure~\ref{preselection_d0} shows the electron and muon \ad distributions in simulated signal and background events that pass the 2018 \Pe\Pgm\ preselection, and Fig.~\ref{signal_cutflow} shows the cumulative number of simulated signal events that pass each 2018 preselection criterion in all three channels for several top squark lifetime hypotheses.

\input{figures/selection/preselection_d0}
\input{figures/selection/preselection_cutflow_signal}

\subsection{Prompt control region}
\label{pcr}
In order to verify the implementation of our selection and corrections to simulation (see Section~\ref{corrections}), we define a prompt control region that is dominated by SM background events. Events in each channel's prompt control region are selected by requiring that they pass all of the criteria defined in Section~\ref{preselection} as well as the requirement that the candidate\fxnote{define candidate?} leptons have $\ad<\SI{50}{\um}$. We define this region in each channel in order to check for reasonable agreement between simulated SM events and data after applying the corrections described in Section~\ref{corrections}. Some examples are shown in Figs.~\ref{pcr_emu_2016}, \ref{pcr_ee_2016}, and \ref{pcr_mumu_2016}, which show the \pt, $\eta$, and \ad distributions of the leptons in the \Pe\Pgm, \Pe\Pe, and \Pgm\Pgm\ prompt control regions, respectively, for 2016 data and background simulation. The data-driven background estimation technique employed in this analysis removes the need for exact agreement between data and simulation, but the absence of any significant discrepancies gives us confidence that we are accounting for the correct sources of prompt SM leptons and that our selection and corrections are functioning as intended.

\input{figures/selection/pcr_emu_2016}
\input{figures/selection/pcr_ee_2016}
\input{figures/selection/pcr_mumu_2016}

\subsection{Inclusive signal region}
Finally, we define the region to which new physics may contribute significantly. The inclusive signal region is populated by events that pass all of the criteria defined in Section~\ref{preselection} as well as the requirement that the candidate leptons each have $\SI{100}{\um}<\ad<\SI{10}{\cm}$. We do not select leptons with $\ad>\SI{10}{\cm}$ because the tracking efficiency drops sharply after this point, as shown in Section~\ref{displaced_tracking_eff}. This requirement also ensures that the leptons originate within the pixel volume, which is effectively required by the pixel hit requirement of the tight lepton IDs. Table~\ref{signal_eff} lists the cumulative efficiency for \stoptolb events to pass the full 2018 inclusive signal region selection for several signal points. To ensure sensitivity to a wide range of new particle masses and lifetimes, we further subdivide the inclusive signal region into bins defined by the \ad of each candidate lepton and the \pt of one candidate lepton. The exact binning is described in Section~\ref{abcd}.

\input{tables/signal_eff}

\pagebreak